# Implementation Plan

*Generated by ralph plan. Do not edit manually.*

## P0 - Blocking Infrastructure

These items must be completed first as they establish the foundation for all other work.

- [x] Replace langchain with @anthropic-ai/claude-agent-sdk in package.json
  - Spec: specs/1-agent-foundation.md § Key Decisions
  - Success: `npm list @anthropic-ai/claude-agent-sdk` succeeds; `npm list langchain` fails (not installed)
  - Test: `test_sdk_dependency_installed`
  - Location: package.json:17
  - Note: TypeScript build fails due to src/chat.ts still importing removed packages - this is expected until that file is deleted per "Files to Remove" section

- [x] Update Node.js version requirement to 22 LTS
  - Spec: specs/1-agent-foundation.md § Key Decisions
  - Success: `package.json` engines field specifies `"node": ">=22"`
  - Test: `test_node_version_requirement`
  - Location: package.json:28-30

- [x] Update environment variables (replace OpenAI with Anthropic)
  - Spec: specs/1-agent-foundation.md § Environment Variables
  - Success: `getEnv()` returns `{ anthropicApiKey, anthropicModel, agentName, agentPhoneNumber }`; OpenAI vars removed; `SIGNAL_CLI_REST_API_URL` removed
  - Test: `test_env_anthropic_config`
  - Location: src/env.ts:5-11

- [x] Create Dockerfile with Node 22 Alpine and signal-cli
  - Spec: specs/4-docker-deployment.md § Dockerfile
  - Success: `docker build .` succeeds; container has `signal-cli` and `node` 22 available
  - Test: `test_dockerfile_builds`
  - Location: Dockerfile (new file)
  - Note: Docker build will fail until prompts/ directory is created (later item) and dist/ is built. Test validates Dockerfile content; actual build requires Docker.

- [x] Replace docker-compose.yml (remove REST API, add jarvis-agent service)
  - Spec: specs/4-docker-deployment.md § docker-compose.yml
  - Success: `docker compose config` shows single `jarvis-agent` service with correct volumes (`signal-data`, `jarvis-workspace`) and environment variables
  - Test: `test_docker_compose_valid`
  - Location: docker-compose.yml

- [x] Create .dockerignore file
  - Spec: specs/4-docker-deployment.md § Dockerfile
  - Success: File exists with node_modules, .git, *.md patterns excluded
  - Test: `test_dockerignore_exists`
  - Location: .dockerignore (new file)

## P1 - Core Agent Architecture

Once infrastructure is in place, implement the core agent model.

- [x] Create prompts/common.md with shared identity and tool instructions
  - Spec: specs/3-agent-behavior.md § Common Prompt
  - Success: File exists at `prompts/common.md` with Jarvis identity, personality, signal-cli instructions, and constraints
  - Test: `test_common_prompt_exists`
  - Location: prompts/common.md (new file)

- [x] Create prompts/dm.md with DM-specific behavior
  - Spec: specs/3-agent-behavior.md § DM Prompt
  - Success: File exists with "always respond" behavior, variable placeholders `{CONTACT_NAME}`, `{CONTACT_PHONE}`, `{AGENT_PHONE_NUMBER}`
  - Test: `test_dm_prompt_exists`
  - Location: prompts/dm.md (new file)

- [x] Create prompts/group.md with discretion examples and pass tool usage
  - Spec: specs/3-agent-behavior.md § Group Prompt
  - Success: File exists with discretion guidelines, pass() tool reference, example exchanges, variable placeholders `{GROUP_NAME}`, `{GROUP_ID}`, `{AGENT_PHONE_NUMBER}`
  - Test: `test_group_prompt_exists`
  - Location: prompts/group.md (new file)

- [x] Implement pass() MCP tool
  - Spec: specs/1-agent-foundation.md § Pass Tool
  - Success: Tool can be called with optional `reason` parameter; logs reason to stdout; returns acknowledgment
  - Test: `test_pass_tool_invocation`
  - Location: src/tools/pass.ts (new file)

- [x] Implement prompt loader with variable substitution
  - Spec: specs/3-agent-behavior.md § Variable Substitution
  - Success: Function `loadPrompt(type: 'dm' | 'group', vars: Record<string, string>)` reads files and substitutes all `{VAR}` patterns
  - Test: `test_prompt_variable_substitution`
  - Location: src/prompts.ts (new file)

- [x] Implement Mailbox model with queue and wake behavior
  - Spec: specs/2-signal-integration.md § Mailbox Model
  - Success: Mailbox class has `enqueue()`, `wake()`, `drainQueue()` methods; tracks `agentBusy` state; queues messages while agent is processing
  - Test: `test_mailbox_queue_and_wake`
  - Location: src/mailbox.ts (new file)

- [x] Implement agent session management with persistence
  - Spec: specs/1-agent-foundation.md § Session Storage
  - Success: Sessions saved to `/home/jarvis/data/sessions.json`; `unstable_v2_resumeSession()` called on startup for existing sessions; `unstable_v2_createSession()` for new chats
  - Test: `test_session_persistence`
  - Location: src/sessions.ts (new file)
  - Note: SessionStore class implemented with getSession, saveSession, removeSession, listChatIds methods. SDK session creation/resumption will be handled in src/agent.ts.

- [x] Implement agent creation per chat (DM vs group prompt selection)
  - Spec: specs/1-agent-foundation.md § Agent model
  - Success: One Claude SDK agent created per unique chat ID; DM chats use dm.md prompt; group chats use group.md prompt; both include common.md prefix
  - Test: `test_agent_per_chat_isolation`
  - Location: src/agent.ts (new file)
  - Note: ChatAgent class creates/resumes SDK sessions with type-specific prompts. Falls back to contactPhone/groupId when names unavailable. Safe to re-initialize (closes old session first).

## P2 - Signal Integration

Direct signal-cli integration replacing REST API.

- [x] Implement receiver loop with `signal-cli receive -t -1 --json`
  - Spec: specs/2-signal-integration.md § Receiver Loop
  - Success: Continuous subprocess reading JSON lines; messages parsed and routed to mailboxes by chat ID
  - Test: `test_receiver_parses_json_messages`
  - Location: src/receiver.ts (new file)
  - Note: Implemented createReceiver() with line-buffered JSON parsing, filtering of receipts/typing, and message routing by chatId. Also implements parseSignalMessage() for text/reaction/attachment parsing.

- [x] Implement chat ID extraction (groupId vs source phone)
  - Spec: specs/2-signal-integration.md § Chat ID Extraction
  - Success: Group messages routed by `groupInfo.groupId`; DMs routed by `source` phone number
  - Test: `test_chat_id_extraction`
  - Location: src/receiver.ts:106-110
  - Note: Implemented in parseSignalMessage() - uses groupInfo.groupId for groups, envelope.source for DMs. Test added in src/receiver.test.ts.

- [x] Implement message formatting with ISO 8601 timestamps
  - Spec: specs/2-signal-integration.md § Message Format
  - Success: Messages formatted as `[{ISO8601}] {senderName} ({senderPhone}): {text}`
  - Test: `test_message_format_iso8601`
  - Location: src/format.ts (new file)
  - Note: Implemented formatTextMessage() and formatTimestamp() utility functions. Uses Date.toISOString() for UTC timestamps.

- [x] Implement reaction formatting with target timestamp
  - Spec: specs/2-signal-integration.md § Reactions
  - Success: Reactions formatted as `[{timestamp}] {reactor} ({phone}) reacted {emoji} to msg@{targetTimestamp} from {author}: "{preview}"`
  - Test: `test_reaction_format`
  - Location: src/format.ts
  - Note: Implemented formatReactionMessage() with optional targetAuthorName and messagePreview. Preview is omitted if not provided (since message history lookup is not yet implemented).

- [x] Implement attachment handling (images inline + save, documents save only)
  - Spec: specs/2-signal-integration.md § Attachments
  - Success: Images saved to `/home/jarvis/downloads/` AND passed inline to Claude; documents saved to disk only; audio/video logged as unsupported
  - Test: `test_attachment_handling`
  - Location: src/attachments.ts (new file)
  - Note: Implemented classifyAttachment(), generateAttachmentFilename(), formatAttachmentLine(), and processAttachment(). Includes path traversal protection via sanitizeFilename() and graceful error handling for file operations. Returns AttachmentResult with type, savedPath, passInline flag, and formatLine for agent context.

- [x] Implement self-message filtering
  - Spec: specs/2-signal-integration.md § Message Types
  - Success: Messages where `source === AGENT_PHONE_NUMBER` are not routed to any mailbox
  - Test: `test_self_message_filtered`
  - Location: src/receiver.ts:213
  - Note: Filter added in createReceiver() before parseSignalMessage() to avoid parsing discarded messages. Tests added for DM and group self-messages.

- [x] Implement receipt/typing indicator filtering
  - Spec: specs/2-signal-integration.md § Message Types
  - Success: Messages with `receiptMessage` or `typingMessage` are ignored (not routed)
  - Test: `test_receipt_typing_filtered`
  - Location: src/receiver.ts:90-98
  - Note: Already implemented in parseSignalMessage() - returns null for receiptMessage or typingMessage. Test renamed to match plan identifier.

- [x] Implement group name resolution via signal-cli listGroups
  - Spec: specs/2-signal-integration.md § Group Name Resolution
  - Success: On startup, `signal-cli listGroups -d` populates ID-to-name cache; unknown group IDs trigger refresh
  - Test: `test_group_name_resolution`
  - Location: src/groups.ts (new file)
  - Note: GroupCache provides load(), getName(), hasGroup(), and getNameWithRefresh() methods. Uses -o json flag for structured output. Handles errors gracefully by continuing with empty cache.

- [x] Implement empty sourceName fallback to phone number
  - Spec: specs/2-signal-integration.md § Contact Name Resolution
  - Success: When `sourceName` is empty or missing, phone number is used as display name
  - Test: `test_empty_source_name_fallback`
  - Location: src/format.ts
  - Note: Changed `??` to `||` operator in formatTextMessage() and formatReactionMessage() to handle both undefined AND empty string cases. Tests added for empty string scenarios.

- [x] Implement signal-cli command blocking (prevent receive)
  - Spec: specs/2-signal-integration.md § Command Blocking
  - Success: SDK `canUseTool` callback returns `{ allowed: false }` when bash command contains `signal-cli` and `receive`
  - Test: `test_signal_receive_blocked`
  - Location: src/tool-validation.ts (new file)
  - Note: Implemented createToolValidator() function returning CanUseTool callback. Uses SDK's `{ behavior: 'deny', message }` format. Integration into agent will occur when orchestrator uses query() API with canUseTool option (V2 session API doesn't support canUseTool yet).

- [ ] Implement batch message delivery to agent
  - Spec: specs/2-signal-integration.md § Batch Delivery
  - Success: When agent turn starts, all queued messages delivered as single user message with "New messages:" prefix
  - Test: `test_batch_message_delivery`
  - Location: src/mailbox.ts

## P3 - Orchestrator & Resilience

Replace main.ts with new orchestrator implementing all coordination.

- [ ] Implement new main.ts orchestrator
  - Spec: specs/1-agent-foundation.md § Files to Create/Modify
  - Success: Main loop coordinates receiver, mailboxes, and agents; manages agent lifecycle
  - Test: `test_orchestrator_startup`
  - Location: src/main.ts

- [ ] Implement exponential backoff on receive failures (1s to 60s cap)
  - Spec: specs/2-signal-integration.md § Retry Backoff
  - Success: Failed receives retry with delays: 1s, 2s, 4s, 8s, 16s, 32s, 60s, 60s...; reset to 1s after success
  - Test: `test_exponential_backoff`
  - Location: src/receiver.ts

- [ ] Implement malformed JSON line handling in receiver
  - Spec: specs/2-signal-integration.md § Edge Cases
  - Success: Invalid JSON lines logged and skipped; receiver continues processing
  - Test: `test_malformed_json_skipped`
  - Location: src/receiver.ts

- [ ] Implement 10-minute turn timeout
  - Spec: specs/1-agent-foundation.md § Key Decisions
  - Success: Agent turns that exceed 10 minutes are logged and terminated; agent goes idle
  - Test: `test_turn_timeout`
  - Location: src/agent.ts

- [x] Implement session resume failure handling
  - Spec: specs/1-agent-foundation.md § Edge Cases
  - Success: When `unstable_v2_resumeSession()` fails, warning logged and fresh session created
  - Test: `test_session_resume_failure`
  - Location: src/sessions.ts
  - Note: SessionStore.removeSession() enables callers to remove failed sessions. Actual retry with fresh session is done in src/agent.ts.

- [x] Implement corrupted sessions.json handling
  - Spec: specs/1-agent-foundation.md § Edge Cases
  - Success: When sessions.json cannot be parsed, error logged and all chats get fresh sessions
  - Test: `test_corrupted_sessions_file`
  - Location: src/sessions.ts
  - Note: Implemented in SessionStore.load() - catches JSON parse errors, logs them, and starts with empty sessions map.

- [ ] Implement agent crash isolation and recovery
  - Spec: specs/1-agent-foundation.md § Edge Cases
  - Success: Individual agent errors logged but don't crash orchestrator; agent recreated on next message
  - Test: `test_agent_crash_isolation`
  - Location: src/agent.ts

## P4 - Observability & Logging

Structured logging with ISO 8601 timestamps and chat ID correlation.

- [ ] Implement structured logging with ISO 8601 timestamps
  - Spec: specs/1-agent-foundation.md § Observability
  - Success: All log lines prefixed with ISO 8601 timestamp (e.g., `2024-01-15T10:30:45.123Z`)
  - Test: `test_log_timestamp_format`
  - Location: src/logger.ts (new file)

- [ ] Implement log types with chat ID correlation
  - Spec: specs/1-agent-foundation.md § Observability
  - Success: Logs include type prefixes: `[receiver]`, `[mailbox:{chatId}]`, `[agent:{chatId}]`, `[thinking]`, `[bash]`, `[bash_result]`, `[pass]`
  - Test: `test_log_types`
  - Location: src/logger.ts

## Files to Remove

These files are replaced by the new architecture and should be deleted:

- [x] `src/chat.ts` - Replaced by per-chat agent model with SDK sessions (specs/1-agent-foundation.md § Files to Remove) - DELETED
- [x] `src/signal-api.ts` - Replaced by direct signal-cli usage via bash (specs/1-agent-foundation.md § Files to Remove) - DELETED

## Files to Modify

| File | Changes |
|------|---------|
| `package.json` | Remove: `langchain`, `lodash`, `@types/lodash`. Add: `@anthropic-ai/claude-agent-sdk`, `zod`. Update: `engines.node` to `>=22` |
| `src/env.ts` | Remove: `signalCliRestApiUrl`, `openAIApiKey`, `openAIModel`. Add: `anthropicApiKey`, `anthropicModel` (default: `claude-sonnet-4-5-20250514`) |
| `src/main.ts` | Complete rewrite: New orchestrator with receiver loop, mailbox routing, agent management |
| `docker-compose.yml` | Complete rewrite: Single jarvis-agent service with correct volumes and environment |

## Files to Create

| File | Purpose |
|------|---------|
| `Dockerfile` | Container definition with Node 22 + signal-cli |
| `.dockerignore` | Exclude node_modules, .git from build context |
| `prompts/common.md` | Shared Jarvis identity and tool instructions |
| `prompts/dm.md` | DM-specific "always respond" behavior |
| `prompts/group.md` | Group discretion guidelines with examples |
| `src/tools/pass.ts` | pass() MCP tool implementation |
| `src/prompts.ts` | Prompt loader with variable substitution |
| `src/mailbox.ts` | Message queue with wake behavior |
| `src/sessions.ts` | Session persistence to sessions.json |
| `src/agent.ts` | Agent creation and lifecycle management |
| `src/receiver.ts` | signal-cli receive subprocess handler |
| `src/format.ts` | Message/reaction formatting |
| `src/attachments.ts` | Attachment save and handling |
| `src/groups.ts` | Group ID to name resolution |
| `src/tool-validation.ts` | canUseTool callback for blocking |
| `src/logger.ts` | Structured logging with timestamps |

## Dependencies

The following items block others:

1. **P0 items block all P1-P4 items** - Cannot implement agent code without SDK installed
2. `package.json` changes block `src/env.ts` changes - Need SDK types available
3. `prompts/*.md` creation blocks `src/prompts.ts` - Need files to load
4. `src/mailbox.ts` blocks `src/main.ts` rewrite - Orchestrator depends on mailbox
5. `src/sessions.ts` blocks `src/agent.ts` - Agent creation needs session management
6. `Dockerfile` blocks `docker-compose.yml` validation - Compose needs to build image

## Test Files to Create

| Test File | Tests |
|-----------|-------|
| `src/env.test.ts` | `test_env_anthropic_config` |
| `src/prompts.test.ts` | `test_common_prompt_exists`, `test_dm_prompt_exists`, `test_group_prompt_exists`, `test_prompt_variable_substitution` |
| `src/tools/pass.test.ts` | `test_pass_tool_invocation` |
| `src/mailbox.test.ts` | `test_mailbox_queue_and_wake`, `test_batch_message_delivery` |
| `src/sessions.test.ts` | `test_session_persistence`, `test_session_resume_failure`, `test_corrupted_sessions_file` |
| `src/agent.test.ts` | `test_agent_per_chat_isolation`, `test_turn_timeout`, `test_agent_crash_isolation` |
| `src/receiver.test.ts` | `test_receiver_parses_json_messages`, `test_chat_id_extraction`, `test_self_message_filtered`, `test_receipt_typing_filtered`, `test_exponential_backoff`, `test_malformed_json_skipped` |
| `src/format.test.ts` | `test_message_format_iso8601`, `test_reaction_format`, `test_empty_source_name_fallback` |
| `src/attachments.test.ts` | `test_attachment_handling` |
| `src/groups.test.ts` | `test_group_name_resolution` |
| `src/tool-validation.test.ts` | `test_signal_receive_blocked` |
| `src/logger.test.ts` | `test_log_timestamp_format`, `test_log_types` |
| `src/main.test.ts` | `test_orchestrator_startup` |
| `docker.test.ts` | `test_dockerfile_builds`, `test_docker_compose_valid`, `test_dockerignore_exists`, `test_node_version_requirement`, `test_sdk_dependency_installed` |
